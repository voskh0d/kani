<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Nondeterministic variables - The Kani Rust Verifier</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Documentation for the Kani Rust Verifier">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="getting-started.html"><strong aria-hidden="true">1.</strong> Getting started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="install-guide.html"><strong aria-hidden="true">1.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="usage.html"><strong aria-hidden="true">1.2.</strong> Usage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kani-single-file.html"><strong aria-hidden="true">1.2.1.</strong> On a single file</a></li><li class="chapter-item expanded "><a href="cargo-kani.html"><strong aria-hidden="true">1.2.2.</strong> On a package</a></li></ol></li><li class="chapter-item expanded "><a href="verification-results.html"><strong aria-hidden="true">1.3.</strong> Verification results</a></li></ol></li><li class="chapter-item expanded "><a href="kani-tutorial.html"><strong aria-hidden="true">2.</strong> Tutorial</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tutorial-first-steps.html"><strong aria-hidden="true">2.1.</strong> First steps</a></li><li class="chapter-item expanded "><a href="tutorial-kinds-of-failure.html"><strong aria-hidden="true">2.2.</strong> Failures that Kani can spot</a></li><li class="chapter-item expanded "><a href="tutorial-loop-unwinding.html"><strong aria-hidden="true">2.3.</strong> Loop unwinding</a></li><li class="chapter-item expanded "><a href="tutorial-nondeterministic-variables.html" class="active"><strong aria-hidden="true">2.4.</strong> Nondeterministic variables</a></li></ol></li><li class="chapter-item expanded "><a href="application.html"><strong aria-hidden="true">3.</strong> Application</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tool-comparison.html"><strong aria-hidden="true">3.1.</strong> Comparison with other tools</a></li><li class="chapter-item expanded "><a href="tutorial-real-code.html"><strong aria-hidden="true">3.2.</strong> Where to start on real code</a></li></ol></li><li class="chapter-item expanded "><a href="dev-documentation.html"><strong aria-hidden="true">4.</strong> Developer documentation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cbmc-hacks.html"><strong aria-hidden="true">4.1.</strong> Working with CBMC</a></li><li class="chapter-item expanded "><a href="rustc-hacks.html"><strong aria-hidden="true">4.2.</strong> Working with rustc</a></li><li class="chapter-item expanded "><a href="cheat-sheets.html"><strong aria-hidden="true">4.3.</strong> Command cheat sheets</a></li><li class="chapter-item expanded "><a href="testing.html"><strong aria-hidden="true">4.4.</strong> Testing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="regression-testing.html"><strong aria-hidden="true">4.4.1.</strong> Regression testing</a></li><li class="chapter-item expanded "><a href="bookrunner.html"><strong aria-hidden="true">4.4.2.</strong> Book runner</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="limitations.html"><strong aria-hidden="true">5.</strong> Limitations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="undefined-behaviour.html"><strong aria-hidden="true">5.1.</strong> Undefined behaviour</a></li><li class="chapter-item expanded "><a href="rust-feature-support.html"><strong aria-hidden="true">5.2.</strong> Rust feature support</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rust-feature-support/intrinsics.html"><strong aria-hidden="true">5.2.1.</strong> Intrinsics</a></li><li class="chapter-item expanded "><a href="rust-feature-support/unstable.html"><strong aria-hidden="true">5.2.2.</strong> Unstable features</a></li></ol></li><li class="chapter-item expanded "><a href="overrides.html"><strong aria-hidden="true">5.3.</strong> Overrides</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Kani Rust Verifier</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/model-checking/kani" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/model-checking/kani/edit/main/docs/src/tutorial-nondeterministic-variables.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="nondeterministic-variables"><a class="header" href="#nondeterministic-variables">Nondeterministic variables</a></h1>
<p>Kani is able to reason about programs and their execution paths by allowing users to assign nondeterministic (i.e., symbolic) values to  certain variables.
Since Kani is a bit-level model checker, this means that Kani considers that an unconstrained nondeterministic value represents all the possible bit-value combinations assigned to the variable's memory contents.</p>
<p>As a Rust developer, this sounds a lot like the <code>mem::transmute</code> operation, which is highly <code>unsafe</code>.
And that's correct.</p>
<p>In this tutorial, we will show how to:</p>
<ol>
<li>Safely use nondeterministic assignments to generate valid symbolic variables that respect Rust's type invariants.</li>
<li>Unsafely use nondeterministic assignments to generate unconstrained symbolic variables that do not respect Rust's type invariants.</li>
<li>Specify invariants for types that you define, enabling the creation of safe nondeterministic variables for those types.</li>
</ol>
<h2 id="safe-nondeterministic-variables"><a class="header" href="#safe-nondeterministic-variables">Safe nondeterministic variables</a></h2>
<p>Let's say you're developing an inventory management tool, and you would like to verify that your API to manage items is correct.
Here is a simple implementation of this API:</p>
<pre><code class="language-rust">use std::num::NonZeroU32;
use vector_map::VecMap;

type ProductId = u32;

pub struct Inventory {
    inner: VecMap&lt;ProductId, NonZeroU32&gt;,
}

impl Inventory {
    pub fn update(&amp;mut self, id: ProductId, new_quantity: NonZeroU32) {
        self.inner.insert(id, new_quantity);
    }

    pub fn get(&amp;self, id: &amp;ProductId) -&gt; Option&lt;NonZeroU32&gt; {
        self.inner.get(id).cloned()
    }
}
</code></pre>
<p>Now we would like to verify that, no matter which combination of <code>id</code> and <code>quantity</code>, a call to <code>Inventory::update()</code> followed by a call to <code>Inventory::get()</code> using the same <code>id</code> returns some value that's equal to the one we inserted:</p>
<pre><code class="language-rust">    #[kani::proof]
    pub fn safe_update() {
        // Create inventory variable.
        let mut inventory = Inventory { inner: VecMap::new() };

        // Create non-deterministic variables for id and quantity.
        let id: ProductId = kani::any();
        let quantity: NonZeroU32 = kani::any();
        assert!(quantity.get() != 0, &quot;NonZeroU32 is internally a u32 but it should never be 0.&quot;);

        // Update the inventory and check the result.
        inventory.update(id.clone(), quantity);
        assert!(inventory.get(&amp;id).unwrap() == quantity);
    }
</code></pre>
<p>In this harness, we use <code>kani::any()</code> to generate the new <code>id</code> and <code>quantity</code>.
<code>kani::any()</code> is a <strong>safe</strong> API function, and it represents only valid values.</p>
<p>If we run this example, Kani verification will succeed, including the assertion that shows that the underlying <code>u32</code> variable  used to represent <code>NonZeroU32</code> cannot be zero, per its type invariant:</p>
<p>You can try it out by running the example under
<a href="https://github.com/model-checking/kani/tree/main/docs/src/tutorial/arbitrary-variables/"><code>arbitrary-variables</code></a>:</p>
<pre><code>cargo kani --harness safe_update
</code></pre>
<h2 id="unsafe-nondeterministic-variables"><a class="header" href="#unsafe-nondeterministic-variables">Unsafe nondeterministic variables</a></h2>
<p>Kani also includes an <strong>unsafe</strong> method to generate unconstrained nondeterministic variables which do not take type invariants into consideration.
As with any unsafe method in Rust, users have to make sure the right guardrails are put in place to avoid undesirable behavior.</p>
<p>That said, there may be cases where you want to verify your code taking into consideration that some inputs may contain invalid data.</p>
<p>Let's see what happens if we modify our verification harness to use the unsafe method <code>kani::any_raw()</code> to generate the updated value.</p>
<pre><code class="language-rust">    #[kani::proof]
    pub fn unsafe_update() {
        // Create inventory variable.
        let mut inventory = Inventory { inner: VecMap::new() };

        // Create non-deterministic variables for id and quantity with unsafe kani::any_raw().
        let id: ProductId = kani::any();
        let quantity: NonZeroU32 = unsafe { kani::any_raw() };

        // The assert bellow would fail if we comment it out.
        // assert!(id.get() != 0, &quot;NonZeroU32 is internally a u32 but it should never be 0.&quot;);

        // Update the inventory and check the result.
        inventory.update(id.clone(), quantity);
        assert!(inventory.get(&amp;id).unwrap() == quantity); // This unwrap will panic.
    }
</code></pre>
<p>We commented out the assertion that the underlying <code>u32</code> variable cannot be <code>0</code>, since this no longer holds.
The verification will now fail showing that the <code>inventory.get(&amp;id).unwrap()</code> method call can panic.</p>
<p>This is an interesting issue that emerges from how <code>rustc</code> optimizes the memory layout of <code>Option&lt;NonZeroU32&gt;</code>.
The compiler is able to represent <code>Option&lt;NonZeroU32&gt;</code> using <code>32</code> bits by using the value <code>0</code> to represent <code>None</code>.</p>
<p>You can try it out by running the example under <a href="https://github.com/model-checking/kani/tree/main/docs/src/tutorial/arbitrary-variables/"><code>arbitrary-variables</code></a>:</p>
<pre><code>cargo kani --harness unsafe_update
</code></pre>
<h2 id="safe-nondeterministic-variables-for-custom-types"><a class="header" href="#safe-nondeterministic-variables-for-custom-types">Safe nondeterministic variables for custom types</a></h2>
<p>Now you would like to add a new structure to your library that allow users to represent a review rating, which can go from 0 to 5 stars.
Let's say you add the following implementation:</p>
<pre><code class="language-rust">#[derive(Copy, Clone)]
pub struct Rating {
    value: u8,
}

impl Rating {
    pub fn from(value: u8) -&gt; Option&lt;Rating&gt; {
        if value &lt;= 5 { Some(Rating { value }) } else { None }
    }

    pub fn get(&amp;self) -&gt; u8 {
        self.value
    }
}

</code></pre>
<p>The easiest way to allow users to create nondeterministic variables of the Rating type which represents values from 0-5 stars is by implementing the <code>kani::Invariant</code> trait.</p>
<p>The implementation only requires you to define a check to your structure that returns whether its current value is valid or not.
In our case, we have the following implementation:</p>
<pre><code class="language-rust">    unsafe impl kani::Invariant for Rating {
        fn is_valid(&amp;self) -&gt; bool {
            self.value &lt;= 5
        }
    }
</code></pre>
<p>Now you can use <code>kani::any()</code> to create valid nondeterministic variables of the Rating type as shown in this harness:</p>
<pre><code class="language-rust">    #[kani::proof]
    pub fn check_rating() {
        let rating = kani::any::&lt;Rating&gt;();
        assert!(rating.get() &lt;= 5);
        assert!(Rating::from(rating.get()).is_some());
    }
</code></pre>
<p>You can try it out by running the example under
<a href="https://github.com/model-checking/kani/tree/main/docs/src/tutorial/arbitrary-variables/"><code>arbitrary-variables</code></a>:</p>
<pre><code>cargo kani --harness check_rating
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="tutorial-loop-unwinding.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="application.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="tutorial-loop-unwinding.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="application.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
